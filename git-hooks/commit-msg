#!/bin/bash

# Ekklesia Commit Message Hook
# Prevents AI authorship markers and political identity mistakes in commit messages
# Installation: cp git-hooks/commit-msg .git/hooks/commit-msg && chmod +x .git/hooks/commit-msg

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo "ü§ñ Checking for AI-generated authorship markers..."

# Check for AI-generated markers in commit message
# Block any AI authorship claims (main author or co-author)
# Matches patterns that appear at start of line or after newline
if echo "$COMMIT_MSG" | grep -E "(^ü§ñ|[[:space:]]ü§ñ|^Generated with.*Claude|^Co-Authored-By:.*Claude|^Co-Authored-By:.*AI|^Author:.*Claude)" > /dev/null; then
    echo ""
    echo "‚ùå BLOCKED: Commit message contains AI authorship markers"
    echo ""
    echo "   Found AI marker in commit message:"
    echo "$(echo "$COMMIT_MSG" | grep -E "(ü§ñ|Generated with.*Claude|Co-Authored-By:.*Claude|Co-Authored-By:.*AI|Author:.*Claude)")"
    echo ""
    echo "   ‚ö†Ô∏è  AUTHORSHIP POLICY:"
    echo "   - Commits must ONLY list human authors"
    echo "   - AI tools (Claude Code, etc.) are assistants, NOT authors"
    echo "   - Do NOT include 'ü§ñ Generated with [Claude Code]'"
    echo "   - Do NOT include 'Co-Authored-By: Claude <...>'"
    echo ""
    echo "   ‚úÖ Correct authorship:"
    echo "      Author: [Your Name] <your@email.com>"
    echo "      (No AI co-author lines)"
    echo ""
    echo "   üìù To fix:"
    echo "      1. Edit commit message: git commit --amend"
    echo "      2. Remove all AI-generated lines"
    echo "      3. Keep only human authorship"
    echo ""
    exit 1
fi

echo "‚úÖ AI authorship check passed"
echo "üè¥ Checking commit message for political identity..."

# Check for wrong party names in commit message
if echo "$COMMIT_MSG" | grep -iE "(Social Democratic|Samfylkingin|Samsta√∞a|Krattaflokkur)" > /dev/null; then
    echo ""
    echo "‚ùå BLOCKED: Commit message contains incorrect party reference"
    echo ""
    echo "   Found: $(echo "$COMMIT_MSG" | grep -iEo "(Social Democratic|Samfylkingin|Samsta√∞a|Krattaflokkur)" | head -1)"
    echo ""
    echo "   ‚ö†Ô∏è  POLITICAL IDENTITY ERROR:"
    echo "   This project is for: S√≥s√≠alistaflokkur √çslands (Socialist Party)"
    echo "   NOT for: Samfylkingin (Social Democratic Alliance)"
    echo ""
    echo "   ‚úÖ Use instead:"
    echo "      - S√≥s√≠alistaflokkur √çslands"
    echo "      - Socialist Party"
    echo "      - S√ç"
    echo ""
    echo "   üìÑ See: archive/docs/docs-2025-10-13/docs/PROJECT_IDENTITY.md"
    echo ""
    echo "   To edit your commit message, use: git commit --amend"
    echo ""
    exit 1
fi

echo "‚úÖ Commit message political identity check passed"
exit 0
