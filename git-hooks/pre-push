#!/bin/bash
# =============================================================================
# Ekklesia Pre-Push Hook - STRANGAR REGLUR
# =============================================================================
# Hindrar push Ã¡ main og athugar commit stÃ¦rÃ°
# =============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

# Get the current branch
current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

# Get the remote and branch being pushed to
while read local_ref local_sha remote_ref remote_sha; do
    remote_branch=$(echo "$remote_ref" | sed 's|refs/heads/||')

    # ==========================================================================
    # RULE 0: Block commits marked "DO NOT PUSH"
    # ==========================================================================
    if [[ "$remote_sha" == "0000000000000000000000000000000000000000" ]]; then
        # New branch - check all commits from main
        blocked_commits=$(git log main.."$local_sha" --oneline --grep="DO NOT PUSH" 2>/dev/null)
    else
        # Existing branch - check new commits only
        blocked_commits=$(git log "$remote_sha".."$local_sha" --oneline --grep="DO NOT PUSH" 2>/dev/null)
    fi

    if [[ -n "$blocked_commits" ]]; then
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}${BOLD}  â›” BLOCKED: Commit marked DO NOT PUSH${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo -e "  ${YELLOW}Eftirfarandi commits eru merktir sem DO NOT PUSH:${NC}"
        echo "$blocked_commits" | while read line; do
            echo -e "    â€¢ $line"
        done
        echo ""
        echo -e "  ${YELLOW}Ãessir commits innihalda kÃ³Ã°a sem Ã¡ ekki aÃ° fara Ã­ remote.${NC}"
        echo -e "  Til aÃ° fjarlÃ¦gja commit: git reset --soft HEAD~1"
        echo ""
        exit 1
    fi

    # ==========================================================================
    # RULE 0.5: Block shadow ban code (secret feature - never push to remote)
    # ==========================================================================
    # Patterns that indicate shadow ban code (from commit 53e26c0)
    SHADOW_BAN_PATTERNS='(shadow.?ban|skugga.?bann|is_kennitala_banned|membershipStatus.*banned|show_non_member_message)'

    # Exclude git-hooks/ from check (hooks contain these patterns for detection)
    # Use ':!git-hooks/' pathspec to exclude the directory
    if [[ "$remote_sha" == "0000000000000000000000000000000000000000" ]]; then
        shadow_ban_code=$(git diff main.."$local_sha" -- ':!git-hooks/' 2>/dev/null | grep -iE "$SHADOW_BAN_PATTERNS" || true)
    else
        shadow_ban_code=$(git diff "$remote_sha".."$local_sha" -- ':!git-hooks/' 2>/dev/null | grep -iE "$SHADOW_BAN_PATTERNS" || true)
    fi

    if [[ -n "$shadow_ban_code" ]]; then
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}${BOLD}  â›” BLOCKED: Shadow ban code detected${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo -e "  ${YELLOW}Ãessi push inniheldur skuggabanns-kÃ³Ã°a sem Ã¡ ALDREI aÃ° fara Ã­ remote.${NC}"
        echo ""
        echo -e "  Fundnar lÃ­nur:"
        echo "$shadow_ban_code" | head -5 | while read line; do
            echo -e "    ${RED}$line${NC}"
        done
        echo ""
        echo -e "  ${YELLOW}Skuggabann er leyndarmÃ¡l - aÃ°eins Ã¡ production, aldrei Ã­ Git.${NC}"
        echo ""
        exit 1
    fi

    # ==========================================================================
    # RULE 1: Block direct push to main
    # ==========================================================================
    if [[ "$remote_branch" == "main" ]]; then
        echo ""
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}${BOLD}  â›” BLOCKED: Push to main not allowed${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo -e "  ${YELLOW}Allar breytingar Ã¡ main VERÃA aÃ° fara Ã­ gegnum PR.${NC}"
        echo ""
        echo -e "  RÃ©tt aÃ°ferÃ°:"
        echo -e "    1. git checkout -b feature/nafn"
        echo -e "    2. git push -u origin feature/nafn"
        echo -e "    3. gh pr create --base main"
        echo -e "    4. gh pr merge --squash"
        echo ""
        echo -e "  SjÃ¡: .github/CONTRIBUTING.md"
        echo ""

        # Allow with explicit override (for emergencies only)
        if [[ "$EKKLESIA_FORCE_PUSH_MAIN" == "1" ]]; then
            echo -e "${YELLOW}  âš ï¸  OVERRIDE: EKKLESIA_FORCE_PUSH_MAIN=1 detected${NC}"
            echo -e "${YELLOW}  Proceeding with push to main...${NC}"
            echo ""
        else
            echo -e "  ${RED}Til aÃ° fara framhjÃ¡ (AÃEINS NEYÃARTILFELLI):${NC}"
            echo -e "    EKKLESIA_FORCE_PUSH_MAIN=1 git push origin main"
            echo ""
            exit 1
        fi
    fi

    # ==========================================================================
    # RULE 2: Check commit size (warn if too small for main-bound branches)
    # ==========================================================================
    if [[ "$remote_branch" == "main" ]] || [[ "$current_branch" =~ ^(feature|fix|refactor)/ ]]; then
        # Count lines changed in commits being pushed
        if [[ "$remote_sha" == "0000000000000000000000000000000000000000" ]]; then
            # New branch - count all commits from main
            lines_changed=$(git diff --stat main..."$local_sha" 2>/dev/null | tail -1 | grep -oE '[0-9]+ insertion|[0-9]+ deletion' | grep -oE '[0-9]+' | paste -sd+ | bc 2>/dev/null || echo "0")
            files_changed=$(git diff --name-only main..."$local_sha" 2>/dev/null | wc -l)
        else
            # Existing branch - count new commits
            lines_changed=$(git diff --stat "$remote_sha".."$local_sha" 2>/dev/null | tail -1 | grep -oE '[0-9]+ insertion|[0-9]+ deletion' | grep -oE '[0-9]+' | paste -sd+ | bc 2>/dev/null || echo "0")
            files_changed=$(git diff --name-only "$remote_sha".."$local_sha" 2>/dev/null | wc -l)
        fi

        # Default to 0 if empty
        lines_changed=${lines_changed:-0}
        files_changed=${files_changed:-0}

        echo -e "${GREEN}ğŸ“Š Commit stats: ${lines_changed} lines, ${files_changed} files${NC}"

        # Warn if too small (but don't block - that's for PR review)
        if [[ "$lines_changed" -lt 50 ]] && [[ "$files_changed" -lt 3 ]]; then
            echo ""
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${YELLOW}  âš ï¸  WARNING: SmÃ¡ar breytingar${NC}"
            echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo ""
            echo -e "  Ãessar breytingar eru undir lÃ¡gmarkskrÃ¶fum:"
            echo -e "    â€¢ ${lines_changed} lÃ­nur (Ã¾arf â‰¥50)"
            echo -e "    â€¢ ${files_changed} skrÃ¡r (Ã¾arf â‰¥3)"
            echo ""
            echo -e "  ÃhugaÃ°u aÃ° sameina viÃ° aÃ°rar breytingar Ã­ einn PR."
            echo -e "  UndanÃ¾Ã¡gur: security fixes, critical bugs"
            echo ""
        fi
    fi
done

echo -e "${GREEN}âœ“ Pre-push checks passed${NC}"
exit 0
