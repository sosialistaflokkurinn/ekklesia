#!/bin/bash

# Ekklesia Pre-commit Hook
# Prevents secrets, PII, and political identity mistakes
# Optimized for performance: Single-pass scanning per file
# Installation: cp git-hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# -----------------------------------------------------------------------------
# CONFIGURATION
# -----------------------------------------------------------------------------

# 1. Secret Patterns (API keys, private keys, DB strings)
SECRET_PATTERNS=(
    "AIza[0-9A-Za-z\\-_]{35}"
    "sk-proj-[0-9A-Za-z]{20}"
    "ghp_[0-9A-Za-z]{36}"
    "xox[baprs]-([0-9a-zA-Z]{10,48})"
    "-----BEGIN PRIVATE KEY-----"
    "-----BEGIN RSA PRIVATE KEY-----"
    "-----BEGIN OPENSSH PRIVATE KEY-----"
    "postgres://.*:.*@"
    "mysql://.*:.*@"
    "mongodb://.*:.*@"
    "redis://.*:.*@"
    "amqp://.*:.*@"
    "FIREBASE_TOKEN=.*"
    "DJANGO_SECRET_KEY=.*"
    "KENNI_IS_CLIENT_SECRET=.*"
)

# 2. PII Patterns (Kennitala, Email, Phone)
PII_PATTERNS=(
    "[0-9]{6}-[0-9]{4}"
    "[0-9]{6}[[:space:]][0-9]{4}"
    "\b[0-9]{3}[-. ][0-9]{4}\b"
    "\b[0-9]{3}[-. ][0-9]{3}[-. ][0-9]{4}\b"
    "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}"
)

# 3. Suspicious Names (Common placeholders that shouldn't be in docs)
SUSPICIOUS_NAMES=(
    "J√≥n J√≥nsson"
    "Gu√∞r√∫n J√≥nsd√≥ttir"
    "Sigur√∞ur Sigur√∞sson"
    "Anna J√≥nsd√≥ttir"
    "Gunnar Gunnarsson"
    "Helga Helgad√≥ttir"
    "√ìlafur √ìlafsson"
    "Krist√≠n Kristj√°nsd√≥ttir"
    "Einar Einarsson"
    "Margr√©t Magn√∫sd√≥ttir"
)

# 4. Allow-list (Fake values used in tests/examples)
FAKE_VALUES=(
    "000000-0000"
    "123456-7890"
    "010101-0101"
    "111111-1111"
    "user@example.com"
    "test@example.com"
    "admin@example.com"
    "support@example.com"
    "info@example.com"
    "contact@example.com"
    "hello@example.com"
    "noreply@example.com"
    "email@domain.com"
    "name@company.com"
    "firstname.lastname@company.com"
    "555-0100"
    "555-0123"
    "555-5555"
    "123-4567"
)

# -----------------------------------------------------------------------------
# INITIALIZATION
# -----------------------------------------------------------------------------

# Helper to join arrays into regex (pipe-separated)
function join_regex {
    local IFS="|"
    echo "$*"
}

# Pre-compile regexes for performance
SECRET_REGEX=$(join_regex "${SECRET_PATTERNS[@]}")
PII_REGEX=$(join_regex "${PII_PATTERNS[@]}")
NAME_REGEX=$(join_regex "${SUSPICIOUS_NAMES[@]}")
FAKE_REGEX=$(join_regex "${FAKE_VALUES[@]}")

EXIT_CODE=0
FILES=$(git diff --cached --name-only --diff-filter=ACMR)

# -----------------------------------------------------------------------------
# SCANNING LOOP
# -----------------------------------------------------------------------------

echo "üîç Running pre-commit checks..."

for FILE in $FILES; do
    # Skip if file doesn't exist (deleted)
    [ ! -f "$FILE" ] && continue
    
    # Skip binary files
    if file -b --mime-encoding "$FILE" | grep -q "binary"; then continue; fi

    # -------------------------------------------------------------------------
    # CHECK 1: Political Identity
    # -------------------------------------------------------------------------
    if grep -qE "(Social Democratic|Samfylkingin|Samsta√∞a|Krattaflokkur)" "$FILE"; then
        echo ""
        echo "‚ùå ERROR: Political identity violation in $FILE"
        echo "   Found incorrect party reference:"
        grep -E --color=always -n "(Social Democratic|Samfylkingin|Samsta√∞a|Krattaflokkur)" "$FILE" | head -5
        echo "   ‚ö†Ô∏è  This project is for S√≥s√≠alistaflokkur √çslands (Socialist Party)."
        EXIT_CODE=1
    fi

    # -------------------------------------------------------------------------
    # CHECK 2: Secrets
    # -------------------------------------------------------------------------
    if grep -qE "$SECRET_REGEX" "$FILE"; then
        echo ""
        echo "‚ùå ERROR: Potential secret found in $FILE"
        grep -E --color=always -n "$SECRET_REGEX" "$FILE" | head -5
        echo "   ‚ö†Ô∏è  Do not commit API keys or secrets."
        EXIT_CODE=1
    fi

    # -------------------------------------------------------------------------
    # CHECK 3: PII (with Allow-list filtering)
    # -------------------------------------------------------------------------
    # First grep for PII patterns
    PII_HITS=$(grep -E -n "$PII_REGEX" "$FILE" || true)
    
    if [ -n "$PII_HITS" ]; then
        # Filter out fake values using grep -v
        REAL_PII=$(echo "$PII_HITS" | grep -vE "$FAKE_REGEX" || true)
        
        if [ -n "$REAL_PII" ]; then
             echo ""
             echo "‚ùå ERROR: PII detected in $FILE"
             echo "$REAL_PII" | head -5
             echo "   ‚ö†Ô∏è  Do not commit real names, emails, or kennit√∂lur."
             EXIT_CODE=1
        fi
    fi

    # -------------------------------------------------------------------------
    # CHECK 4: Suspicious Names
    # -------------------------------------------------------------------------
    if grep -qE "$NAME_REGEX" "$FILE"; then
        echo ""
        echo "‚ùå ERROR: Suspicious name found in $FILE"
        grep -E --color=always -n "$NAME_REGEX" "$FILE" | head -5
        echo "   ‚ö†Ô∏è  Avoid using common placeholder names that might be real people."
        EXIT_CODE=1
    fi
done

# -----------------------------------------------------------------------------
# SUMMARY
# -----------------------------------------------------------------------------

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "üö´ Commit blocked due to policy violations."
    echo "   Fix the issues above and try again."
    echo "   (Use --no-verify to bypass if absolutely necessary)"
    echo ""
else
    echo "‚úÖ All checks passed."
fi

exit $EXIT_CODE
