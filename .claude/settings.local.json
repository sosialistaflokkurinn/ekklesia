{
  "includeCoAuthoredBy": false,
  "permissions": {
    "allow": [
      "Bash(git add:*)"
    ],
    "deny": [],
    "ask": []
  },
  "hooks": {
    "SessionStart": [
      {
        "hooks": [
          {
            "type": "command",
            "command": "cat /home/gudro/Development/projects/ekklesia/docs/status/CURRENT_DEVELOPMENT_STATUS.md"
          },
          {
            "type": "command",
            "command": "cat /home/gudro/Development/projects/ekklesia/docs/development/guides/workflows/USAGE_CONTEXT.md"
          },
          {
            "type": "command",
            "command": "cat /home/gudro/Development/projects/ekklesia/docs/operations/OPERATIONAL_PROCEDURES.md"
          },
          {
            "type": "command",
            "command": "cat /home/gudro/Development/projects/ekklesia/docs/SESSION_START_REMINDER.md"
          },
          {
            "type": "command",
            "command": "cat /home/gudro/Development/projects/ekklesia/docs/infrastructure/CLOUD_RUN_SERVICES.md"
          },
          {
            "type": "instruction",
            "instruction": "â˜ï¸ CLOUD RUN SERVICES ARCHITECTURE:\n\nThis project has 13 Cloud Run services (see CLOUD_RUN_SERVICES.md for full details):\n\nðŸ”‘ AUTHENTICATION & AUTH SERVICES:\n1. handlekenniauth (Python 3.13) - Kenni.is OAuth with PKCE\n   - URL: https://handlekenniauth-ymzrguoifa-nw.a.run.app\n   - Secret: KENNI_IS_CLIENT_SECRET (kenni-client-secret:latest)\n   - Flow: PKCE code verifier + challenge â†’ ID token â†’ Firebase custom token\n   - Rate limiting: 10 attempts per 10 min per IP\n\n2. verifymembership - Membership verification\n3. healthz (Python 3.13) - Config sanity checks + JWKS cache stats\n\nðŸ“Š DATA SYNC SERVICES (ALL use DJANGO_API_TOKEN):\n4. syncmembers (Python 3.13) - Manual admin-triggered sync\n5. bidirectional-sync (Python 3.13) - Scheduled daily 3:30 AM sync\n6. updatememberprofile (Python 3.13) - Self-service profile updates\n7. updatememberforeignaddress (Python 3.13) - Foreign address CRUD\n8. get-django-token (Python 3.13) - Admin token access\n\nðŸ—³ï¸ VOTING SERVICES:\n9. elections-service (Node.js) - Anonymous ballot recording\n10. events-service (Node.js) - Voting token issuance\n\nðŸ“ AUDIT:\n11. auditmemberchanges - Audit logging\n\nðŸ”’ SECRET MANAGER INTEGRATION (Critical!):\n\n**Philosophy**: ALL secrets injected via environment variables at Cloud Run startup.\nNEVER call Secret Manager API directly from code.\n\n**Secrets in use:**\n- kenni-client-secret â†’ handlekenniauth (OAuth)\n- django-api-token â†’ 5 services (Django API auth)\n\n**Configuration pattern:**\n```bash\ngcloud run services update SERVICE_NAME \\\n  --set-secrets=\"DJANGO_API_TOKEN=django-api-token:latest\"\n```\n\n**Code pattern:**\n```python\n# âœ… CORRECT: Read from environment\ntoken = os.environ.get('DJANGO_API_TOKEN')\nif not token:\n    raise ValueError(\"DJANGO_API_TOKEN not set\")\n\n# âŒ WRONG: Direct Secret Manager API call\nclient = SecretManagerServiceClient()  # DON'T DO THIS!\n```\n\nâš ï¸ WHEN DEPLOYING FUNCTIONS:\n\n1. **Firebase deploy** may reset Cloud Run secrets:\n   ```bash\n   firebase deploy --only functions:syncmembers\n   # âš ï¸ This may remove --set-secrets configuration!\n   ```\n\n2. **Always verify after deploy:**\n   ```bash\n   gcloud run services describe SERVICE \\\n     --region=europe-west2 --project=ekklesia-prod-10-2025 \\\n     --format=\"json\" | grep -A5 secretKeyRef\n   ```\n\n3. **Re-apply secrets if missing:**\n   ```bash\n   gcloud run services update SERVICE \\\n     --region=europe-west2 --project=ekklesia-prod-10-2025 \\\n     --set-secrets=\"DJANGO_API_TOKEN=django-api-token:latest\"\n   ```\n\nðŸ” AUTH FLOW (handlekenniauth - PKCE):\n\n1. Frontend: Generate PKCE verifier + SHA256 challenge\n2. Frontend: Redirect to Kenni.is with challenge\n3. User: Authenticate with Icelandic eID (kennitala)\n4. Kenni.is: Redirect back with authorization code\n5. Frontend: POST code + verifier to handlekenniauth\n6. handlekenniauth: Exchange code for ID token (validates verifier)\n7. handlekenniauth: Verify ID token signature (JWKS cache)\n8. handlekenniauth: Create/update Firebase user\n9. handlekenniauth: Issue Firebase custom token\n10. Frontend: Sign in with custom token\n\nðŸ“‹ REMEMBER:\n- All 13 services scale to zero (cost optimization)\n- All use Python 3.13 (except elections/events with Node.js)\n- All secrets via environment variables (NOT Secret Manager API)\n- Secret Manager configuration can be lost after Firebase deploy\n- Always verify secrets after deployment\n\nFor full details: docs/infrastructure/CLOUD_RUN_SERVICES.md"
          },
          {
            "type": "instruction",
            "instruction": "ðŸ” SECURITY RULE: NEVER bypass git hooks with --no-verify. Pre-commit hooks detect exposed secrets, PII, and security issues. If a hook fails or hangs:\n\n1. INVESTIGATE what the hook detected\n2. UNDERSTAND why it flagged the commit\n3. FIX the issue (e.g., remove secrets, fix PII)\n4. If hook performance is slow, FIX THE HOOK not bypass it\n\nExample from Nov 7, 2025 session:\n- Hook detected: CF_API_TOKEN=\"gD0MXa-Y6K3n8pDDxbkyJnJuy-YIGl2KTOyD3Rn7\" in git diff\n- Action: We were REMOVING this secret from scripts/README.md (correct action)\n- Problem: Hook was too slow (needs timeout optimization)\n- Wrong solution: --no-verify\n- Right solution: Investigate, understand, then commit after confirming we're removing (not adding) secrets\n\nThe hook hung due to performance issues (scanning git history), NOT false positive. The commit was removing an exposed Cloudflare API token (GOOD), but hook needed optimization.\n\nFIXED: Pre-commit hook now has timeouts (5s total, 1s per grep operation) to prevent hanging.\n\nREMEMBER: Security hooks exist to prevent credential leaks. Respect them.\n\nDEBUG PROCESS:\n```bash\n# 1. Investigate\ngit diff --cached | grep -i \"password\\|token\\|secret\\|api.*key\"\n\n# 2. Understand context\n# Are we ADDING or REMOVING secrets?\n\n# 3. Fix appropriately\n# Adding secrets: STOP! Remove them, use Secret Manager\n# Removing secrets: GOOD! Commit is safe\n# Hook hanging: Fix hook performance (timeout added Nov 7, 2025)\n```"
          },
          {
            "type": "instruction",
            "instruction": "ðŸ“ PROJECT STRUCTURE RULE: Maintain clean project organization. DO NOT create files/directories in project root unless they follow established structure and best practices.\n\n## âœ… ALLOWED in Project Root:\n- Essential config files: .gitignore, package.json, firebase.json, README.md\n- Standard directories: /apps/, /scripts/, /docs/, /testing/, /services/\n\n## âŒ FORBIDDEN in Project Root:\n- Binary files (cloud-sql-proxy, executables)\n- Temporary files (.log, .json audits, backup files)\n- Debug/development HTML files\n- Documentation scattered files\n- Test reports (belongs in /docs/testing/reports/)\n- Database scripts (belongs in /scripts/database/)\n- Development tools (belongs in /apps/members-portal/dev-tools/)\n\n## ðŸ“‚ Established Structure (Nov 8, 2025 cleanup):\n```\n/\nâ”œâ”€â”€ /apps/members-portal/\nâ”‚   â”œâ”€â”€ /members-area/          â† Hub (dashboard + profile)\nâ”‚   â”œâ”€â”€ /elections/             â† Elections area\nâ”‚   â”œâ”€â”€ /events/                â† Events area\nâ”‚   â”œâ”€â”€ /policy-session/        â† Policy area\nâ”‚   â”œâ”€â”€ /dev-tools/             â† Debug utilities\nâ”‚   â”œâ”€â”€ /js/, /styles/, /i18n/  â† Global resources\nâ”‚   â””â”€â”€ (no loose files)\nâ”‚\nâ”œâ”€â”€ /docs/\nâ”‚   â”œâ”€â”€ /architecture/          â† System design docs\nâ”‚   â”œâ”€â”€ /development/           â† Dev guides\nâ”‚   â””â”€â”€ /testing/reports/       â† Test documentation\nâ”‚\nâ”œâ”€â”€ /testing/\nâ”‚   â””â”€â”€ /integration/           â† Test CODE only (no docs)\nâ”‚\nâ”œâ”€â”€ /scripts/\nâ”‚   â”œâ”€â”€ /database/examples/     â† SQL examples\nâ”‚   â””â”€â”€ /deployment/            â† Deploy scripts\nâ”‚\nâ””â”€â”€ /tmp/                       â† TEMPORARY FILES GO HERE\n```\n\n## ðŸ—‘ï¸ Use /tmp/ for Temporary Work:\n\n**ALWAYS use /tmp/ directory for:**\n- Temporary reorganization files\n- Work-in-progress files\n- Experimental scripts\n- Debugging outputs\n- Files with no preservation value\n- Quick tests or prototypes\n\n**Example:**\n```bash\n# âŒ WRONG: Creating temp file in root\ncat > /path/to/project/test-output.json\n\n# âœ… RIGHT: Use tmp directory\nmkdir -p /path/to/project/tmp\ncat > /path/to/project/tmp/test-output.json\n```\n\n**Add to .gitignore:**\n```gitignore\n# Temporary working directory\ntmp/\n*.tmp\n```\n\n## ðŸš¨ Before Creating Files:\n\n**Ask yourself:**\n1. Is this a permanent file with preservation value?\n   - YES â†’ Find proper location in structure\n   - NO â†’ Use /tmp/\n\n2. Does it follow best practices?\n   - Code â†’ /testing/, /scripts/, /apps/\n   - Docs â†’ /docs/\n   - Temp â†’ /tmp/\n\n3. Is there an existing location for this?\n   - Test reports â†’ /docs/testing/reports/\n   - Debug tools â†’ /apps/members-portal/dev-tools/\n   - SQL examples â†’ /scripts/database/examples/\n\nREMEMBER: Clean structure = maintainable codebase. Keep root clean!"
          },
          {
            "type": "instruction",
            "instruction": "ðŸ“‚ GITIGNORED FILES AWARENESS:\n\nThis project has LOCAL-ONLY files that should NEVER be committed:\n\nðŸš¨ CRITICAL PATTERNS TO AVOID:\n1. Policy docs: docs/policy/IMMIGRATION_POLICY_MEETING_2025-11-08.md\n   - Contains meeting notes with personal opinions and draft policies\n   - ALL files in docs/policy/ are gitignored\n\n2. PII patterns:\n   - *KENNITALA*.md, *kennitala*.md (Icelandic national IDs)\n   - *DUPLICATE_SSN*.md (SSN analysis documents)\n   - *DJANGO_KENNITALA*.md (Django kennitala data)\n   - *pii_redaction*.md (PII redaction reports)\n\n3. Admin scripts:\n   - services/members/scripts/check-user-logins.js\n   - services/members/scripts/check-logins-today.js\n   - These query production Firestore with potential PII\n\nðŸ“‹ Full catalog: docs/development/LOCAL_ONLY_FILES.md\n\nâš ï¸ BEFORE CREATING FILES WITH SENSITIVE DATA:\n1. Check if pattern exists in .gitignore\n2. Add to .gitignore if needed\n3. Update LOCAL_ONLY_FILES.md catalog\n4. NEVER use 'git add -f' without explicit user approval\n\nðŸ” Related docs:\n- docs/development/guides/GITIGNORE_STRATEGY.md - Two-tier .gitignore approach\n- docs/SESSION_START_REMINDER.md - Security checklist\n- .gitignore - Current ignore rules"
          },
          {
            "type": "instruction",
            "instruction": "ðŸ”’ PRE-COMMIT SAFETY CHECK:\n\nBefore running 'git add' or 'git commit', ALWAYS verify files aren't gitignored:\n\n```bash\n# Check if specific file should be ignored\ngit check-ignore -v path/to/file\n\n# List all staged files that match gitignore patterns (CRITICAL CHECK!)\ngit diff --cached --name-only | while read f; do \n  git check-ignore -q \"$f\" && echo \"âš ï¸  WARNING: $f matches .gitignore\"\ndone\n```\n\nðŸš¨ IF YOU SEE A MATCH:\n1. STOP immediately - file should NOT be committed\n2. Check docs/development/LOCAL_ONLY_FILES.md for why it's ignored\n3. Verify you're not accidentally committing:\n   - Policy meeting notes (docs/policy/)\n   - Files with kennitÃ¶lur (*KENNITALA*.md)\n   - Admin scripts with PII (services/members/scripts/check-*.js)\n4. If unsure, ASK USER before proceeding\n\nâœ… SAFE PATTERNS:\n- Adding files to .gitignore itself\n- Removing already-committed files (git rm --cached)\n- Committing docs that reference LOCAL_ONLY_FILES.md\n\nâŒ DANGEROUS PATTERNS:\n- Using 'git add -f' (force add) - requires user approval\n- Committing files from docs/policy/\n- Adding files matching *KENNITALA* or *kennitala* patterns\n\nREMEMBER: When in doubt, check the catalog first!"
          },
          {
            "type": "instruction",
            "instruction": "ðŸ“ DOCUMENTATION MAINTENANCE REMINDER:\n\nThe following key documents are loaded at session start and MUST be kept up-to-date:\n\n1. **CURRENT_DEVELOPMENT_STATUS.md** - Current system state\n   - Infrastructure services and their status\n   - Recent deployments and changes\n   - Known issues and ongoing work\n   - Last updated: Check file header\n\n2. **USAGE_CONTEXT.md** - Context and patterns\n   - How the system is used\n   - Common workflows\n   - Integration patterns\n   - Last updated: Check file header\n\n3. **OPERATIONAL_PROCEDURES.md** - Operational rules\n   - Deployment procedures\n   - Incident response\n   - Database operations\n   - Last updated: Check file header\n\n4. **SESSION_START_REMINDER.md** - Security rules and checklists\n   - PII protection rules\n   - Gitignore patterns\n   - Security best practices\n   - Last updated: Check file footer\n\nâš ï¸ WHEN TO UPDATE THESE DOCS:\n\n**After deployments:**\n- Update CURRENT_DEVELOPMENT_STATUS.md with new service versions\n- Update OPERATIONAL_PROCEDURES.md if deployment process changed\n\n**After infrastructure changes:**\n- Update CURRENT_DEVELOPMENT_STATUS.md with new services/databases\n- Update USAGE_CONTEXT.md if integration patterns changed\n\n**After security changes:**\n- Update SESSION_START_REMINDER.md with new security rules\n- Update LOCAL_ONLY_FILES.md if gitignore patterns added\n\n**After adding new workflows:**\n- Update USAGE_CONTEXT.md with new patterns\n- Update OPERATIONAL_PROCEDURES.md if operational steps changed\n\nðŸ” AT END OF SESSION:\nBefore ending session, review commits and ask:\n- Did I deploy new infrastructure? â†’ Update CURRENT_DEVELOPMENT_STATUS.md\n- Did I change operational procedures? â†’ Update OPERATIONAL_PROCEDURES.md\n- Did I add new security rules? â†’ Update SESSION_START_REMINDER.md\n- Did I change system usage patterns? â†’ Update USAGE_CONTEXT.md\n\nðŸ“‹ Quick check command:\n```bash\n# Check when these docs were last updated\nfor doc in docs/status/CURRENT_DEVELOPMENT_STATUS.md \\\n           docs/development/guides/workflows/USAGE_CONTEXT.md \\\n           docs/operations/OPERATIONAL_PROCEDURES.md \\\n           docs/SESSION_START_REMINDER.md; do\n  echo \"$doc: $(git log -1 --format='%cr (%ci)' -- \"$doc\" 2>/dev/null || echo 'Never committed')\"\ndone\n```\n\nREMEMBER: These docs are your session context - keep them accurate!"
          }
        ]
      }
    ]
  }
}
