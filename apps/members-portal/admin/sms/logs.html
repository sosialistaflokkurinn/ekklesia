<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SMS Annáll - Ekklesia</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Reuse member portal styles -->
  <link rel="stylesheet" href="/styles/bundle.css?v=20251217k">

  <!-- Admin-specific styles -->
  <link rel="stylesheet" href="/admin/styles/admin.css?v=20260112a">
</head>
<body class="authenticated admin">
  <!-- Navigation component inserted here -->

  <!-- Page Content -->
  <div class="page__container">
    <!-- Back to SMS Dashboard -->
    <a href="/admin/sms/" class="back-link">&larr; Til baka í SMS</a>

    <!-- Logs List -->
    <div class="card">
      <h2 class="card__title">SMS Annáll</h2>

      <div id="logs-loading" class="loading-state">
        <div class="loading-spinner"></div>
        <p>Hleð annál...</p>
      </div>

      <div id="logs-empty" class="empty-state u-hidden">
        <p>Engin SMS hafa verið send.</p>
      </div>

      <table class="data-table u-hidden" id="logs-table">
        <thead>
          <tr>
            <th>Viðtakandi</th>
            <th>Staða</th>
            <th>Hlutar</th>
            <th>Sent</th>
          </tr>
        </thead>
        <tbody id="logs-tbody">
          <!-- Logs will be inserted here -->
        </tbody>
      </table>
    </div>
  </div>

  <script type="module">
    import { initSession, showAuthenticatedContent } from '../../../session/init.js';
    import { AuthenticationError } from '../../../session/auth.js';
    import { debug } from '../../../js/utils/util-debug.js';
    import { requireAdmin } from '../../../js/rbac.js';
    import { showError } from '../../../js/components/ui-toast.js';
    import { escapeHTML } from '../../../js/utils/util-format.js';
    import SmsAPI from './js/api/sms-api.js';

    const loadingEl = document.getElementById('logs-loading');
    const emptyEl = document.getElementById('logs-empty');
    const tableEl = document.getElementById('logs-table');
    const tbodyEl = document.getElementById('logs-tbody');

    const statusLabels = {
      sent: 'Sent',
      delivered: 'Afhent',
      failed: 'Mistókst'
    };

    const statusBadges = {
      sent: 'badge--info',
      delivered: 'badge--success',
      failed: 'badge--error'
    };

    function formatDate(isoString) {
      if (!isoString) return '-';
      const date = new Date(isoString);
      return date.toLocaleString('is-IS', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    async function loadLogs() {
      loadingEl.classList.remove('u-hidden');
      emptyEl.classList.add('u-hidden');
      tableEl.classList.add('u-hidden');

      try {
        const result = await SmsAPI.listLogs({ limit: 100 });
        const logs = result.logs || [];

        loadingEl.classList.add('u-hidden');

        if (logs.length === 0) {
          emptyEl.classList.remove('u-hidden');
        } else {
          renderLogs(logs);
          tableEl.classList.remove('u-hidden');
        }
      } catch (error) {
        debug.error('[SmsLogs] Load error:', error);
        loadingEl.classList.add('u-hidden');
        showError(`Villa: ${error.message}`);
      }
    }

    function renderLogs(logs) {
      tbodyEl.innerHTML = logs.map(log => {
        const statusLabel = statusLabels[log.status] || log.status;
        const statusBadge = statusBadges[log.status] || 'badge--default';

        return `
          <tr>
            <td>${escapeHTML(log.recipient_phone || '-')}</td>
            <td><span class="badge ${statusBadge}">${statusLabel}</span></td>
            <td>${log.segment_count || 1}</td>
            <td>${formatDate(log.sent_at)}</td>
          </tr>
        `;
      }).join('');
    }

    async function init() {
      try {
        await initSession();
        await requireAdmin();
        showAuthenticatedContent();
        await loadLogs();
        debug.log('[SmsLogs] Initialized');
      } catch (error) {
        debug.error('[SmsLogs] Init failed:', error);
        if (error instanceof AuthenticationError) {
          window.location.href = '/';
          return;
        }
        if (!error.message?.includes('Admin role required')) {
          showError(`Villa: ${error.message}`);
        }
      }
    }

    init();
  </script>

  <!-- Initialize Navigation Component -->
  <script type="module">
    import { initNavHeader, NAV_CONFIGS } from '../../../ui/components/navigation-bar.js?v=20260115';
    await initNavHeader(NAV_CONFIGS.adminSms);
  </script>

</body>
</html>
