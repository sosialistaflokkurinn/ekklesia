<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title" data-i18n="architecture_page_title">Kerfisarkitektúr - Kerfisstjórn</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Reuse member portal styles -->
  <link rel="stylesheet" href="/styles/bundle.css?v=20251202">

  <!-- Superuser-specific styles -->
  <link rel="stylesheet" href="/superuser/styles/superuser.css?v=20251201f">
</head>
<body class="authenticated superuser">
  <!-- Navigation component inserted here -->

  <!-- Page Content -->
  <div class="page__container">
    <!-- Header Card -->
    <div class="card">
      <div class="health-header">
        <div>
          <h1 class="card__title" id="title" data-i18n="architecture_title">Kerfisarkitektúr</h1>
          <p class="card__description" id="description" data-i18n="architecture_description">Lifandi yfirlit yfir allar þjónustur og gagnaflæði.</p>
        </div>
        <button type="button" class="btn btn--outline" id="refresh-btn" data-i18n="architecture_refresh_btn">
          Uppfæra
        </button>
      </div>
      <div class="health-summary" id="health-summary">
        <div class="health-summary__status health-summary__status--loading">
          <span class="health-summary__dot"></span>
          <span class="health-summary__text" data-i18n="health_checking">Athuga stöðu...</span>
        </div>
        <span class="health-summary__time" id="last-updated">-</span>
      </div>
    </div>

    <!-- Architecture Diagram Card -->
    <div class="card">
      <h2 class="card__title" data-i18n="architecture_overview_title">Kerfisyfirlit</h2>
      <p class="card__description u-text-muted" data-i18n="architecture_click_group">Smelltu á hóp til að sjá nákvæmari upplýsingar.</p>

      <!-- SVG Architecture Diagram -->
      <div class="architecture-diagram" id="architecture-diagram">
        <svg viewBox="0 0 820 580" preserveAspectRatio="xMidYMid meet">
          <!-- Definitions for markers and gradients -->
          <defs>
            <!-- Arrow marker for connection lines -->
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="var(--color-muted, #9ca3af)" />
            </marker>

            <!-- Gradient for animated flow -->
            <linearGradient id="flowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="var(--color-success, #22c55e)" stop-opacity="0.3" />
          <stop offset="50%" stop-color="var(--color-success, #22c55e)" stop-opacity="1" />
          <stop offset="100%" stop-color="var(--color-success, #22c55e)" stop-opacity="0.3" />
            </linearGradient>
          </defs>

          <!-- Background grid (subtle) -->
          <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="var(--color-border, #e5e7eb)" stroke-width="0.5" opacity="0.5"/>
          </pattern>
          <rect width="100%" height="100%" fill="url(#grid)" />

          <!-- Layer 1: Users -->
          <g class="architecture-layer" id="layer-users">
            <rect x="250" y="10" width="300" height="50" rx="8" class="architecture-node architecture-node--external" />
            <text x="400" y="40" text-anchor="middle" class="architecture-node__label">Notendur</text>
            <text x="400" y="55" text-anchor="middle" class="architecture-node__sublabel">Félagar / Stjórnendur / Kerfisstjórar</text>
          </g>

          <!-- Connection: Users to Firebase Hosting -->
          <path d="M 400 60 L 400 90" class="architecture-edge" marker-end="url(#arrowhead)" />

          <!-- Layer 2: Firebase Hosting (Frontend) -->
          <g class="architecture-layer" id="layer-frontend">
            <rect x="100" y="90" width="600" height="80" rx="8" class="architecture-node architecture-node--firebase" />
            <text x="400" y="115" text-anchor="middle" class="architecture-node__label">Firebase Hosting</text>

            <!-- Three portals -->
            <g class="architecture-subnode" data-portal="members">
              <rect x="130" y="125" width="140" height="35" rx="4" class="architecture-node architecture-node--healthy" />
              <text x="200" y="147" text-anchor="middle" class="architecture-subnode__label">Félagagátt</text>
            </g>
            <g class="architecture-subnode" data-portal="admin">
              <rect x="330" y="125" width="140" height="35" rx="4" class="architecture-node architecture-node--healthy" />
              <text x="400" y="147" text-anchor="middle" class="architecture-subnode__label">Stjórnendagátt</text>
            </g>
            <g class="architecture-subnode" data-portal="superuser">
              <rect x="530" y="125" width="140" height="35" rx="4" class="architecture-node architecture-node--healthy" />
              <text x="600" y="147" text-anchor="middle" class="architecture-subnode__label">Kerfisstjórn</text>
            </g>
          </g>

          <!-- Connections: Frontend to services -->
          <path d="M 200 170 L 200 210" class="architecture-edge" marker-end="url(#arrowhead)" />
          <path d="M 400 170 L 400 210" class="architecture-edge" marker-end="url(#arrowhead)" />
          <path d="M 600 170 L 600 210" class="architecture-edge" marker-end="url(#arrowhead)" />

          <!-- Layer 3: Firebase Services -->
          <g class="architecture-layer" id="layer-firebase">
            <!-- Firebase Auth -->
            <g class="architecture-group" id="group-auth" data-group="auth">
              <rect x="100" y="210" width="160" height="70" rx="8" class="architecture-node architecture-node--group" />
              <text x="180" y="235" text-anchor="middle" class="architecture-node__label">Auðkenning</text>
              <text x="180" y="255" text-anchor="middle" class="architecture-node__count">2 þjónustur</text>
              <circle cx="240" cy="225" r="8" class="architecture-status" id="status-auth" />
            </g>

            <!-- Firestore -->
            <g class="architecture-group" id="group-firestore" data-group="firestore">
              <rect x="320" y="210" width="160" height="70" rx="8" class="architecture-node architecture-node--group" />
              <text x="400" y="235" text-anchor="middle" class="architecture-node__label">Firestore</text>
              <text x="400" y="255" text-anchor="middle" class="architecture-node__count">Gagnagrunnur</text>
              <circle cx="460" cy="225" r="8" class="architecture-status" id="status-firestore" />
            </g>

            <!-- Cloud Run -->
            <g class="architecture-group" id="group-cloudrun" data-group="cloudrun">
              <rect x="540" y="210" width="160" height="70" rx="8" class="architecture-node architecture-node--group" />
              <text x="620" y="235" text-anchor="middle" class="architecture-node__label">Cloud Run</text>
              <text x="620" y="255" text-anchor="middle" class="architecture-node__count">22 þjónustur</text>
              <circle cx="680" cy="225" r="8" class="architecture-status" id="status-cloudrun" />
            </g>
          </g>

          <!-- Data flow connections (animated) - DRAWN FIRST so they appear behind nodes -->
          <g class="architecture-layer" id="layer-flows">
            <!-- Connections from Cloud Run to service groups (static, no animation) -->
            <path d="M 620 280 L 115 320" class="architecture-edge architecture-edge--thin" />
            <path d="M 620 280 L 265 320" class="architecture-edge architecture-edge--thin" />
            <path d="M 620 280 L 415 320" class="architecture-edge architecture-edge--thin" />
            <path d="M 620 280 L 565 320" class="architecture-edge architecture-edge--thin" />
            <path d="M 620 280 L 715 320" class="architecture-edge architecture-edge--thin" />

            <!-- 1. Django → Firestore (sync-from-django webhook) -->
            <path d="M 530 430 L 580 400 L 580 290 L 480 280" class="architecture-edge architecture-edge--flow architecture-edge--sync-from-django" id="flow-django-firestore" />

            <!-- 2. Firestore → Django (profile updates) -->
            <path d="M 400 280 L 400 400 L 450 430" class="architecture-edge architecture-edge--flow architecture-edge--sync-to-django" id="flow-firestore-django" />

            <!-- 3. Cloud Run → Cloud SQL (database queries) -->
            <path d="M 415 380 L 350 430" class="architecture-edge architecture-edge--flow architecture-edge--database" id="flow-cloudrun-sql" />

            <!-- 4. Kenni.is → Auth (OAuth 2.0 flow) -->
            <path d="M 120 430 L 120 290 L 180 280" class="architecture-edge architecture-edge--flow architecture-edge--auth" id="flow-kenni" />
          </g>

          <!-- Layer 4: Cloud Run Service Groups -->
          <g class="architecture-layer" id="layer-services">
            <!-- Data Sync -->
            <g class="architecture-group architecture-group--clickable" id="group-sync" data-group="sync">
              <rect x="50" y="320" width="130" height="60" rx="6" class="architecture-node architecture-node--group" />
              <text x="115" y="345" text-anchor="middle" class="architecture-node__label">Samstilling</text>
              <text x="115" y="362" text-anchor="middle" class="architecture-node__count">3 þjónustur</text>
              <circle cx="160" cy="335" r="6" class="architecture-status" id="status-sync" />
            </g>

            <!-- Address Validation -->
            <g class="architecture-group architecture-group--clickable" id="group-address" data-group="address">
              <rect x="200" y="320" width="130" height="60" rx="6" class="architecture-node architecture-node--group" />
              <text x="265" y="345" text-anchor="middle" class="architecture-node__label">Heimilisföng</text>
              <text x="265" y="362" text-anchor="middle" class="architecture-node__count">3 þjónustur</text>
              <circle cx="310" cy="335" r="6" class="architecture-status" id="status-address" />
            </g>

            <!-- Voting Services -->
            <g class="architecture-group architecture-group--clickable" id="group-voting" data-group="voting">
              <rect x="350" y="320" width="130" height="60" rx="6" class="architecture-node architecture-node--group" />
              <text x="415" y="345" text-anchor="middle" class="architecture-node__label">Kosningar</text>
              <text x="415" y="362" text-anchor="middle" class="architecture-node__count">2 þjónustur</text>
              <circle cx="460" cy="335" r="6" class="architecture-status" id="status-voting" />
            </g>

            <!-- Audit & Monitoring -->
            <g class="architecture-group architecture-group--clickable" id="group-audit" data-group="audit">
              <rect x="500" y="320" width="130" height="60" rx="6" class="architecture-node architecture-node--group" />
              <text x="565" y="345" text-anchor="middle" class="architecture-node__label">Eftirlit</text>
              <text x="565" y="362" text-anchor="middle" class="architecture-node__count">3 þjónustur</text>
              <circle cx="610" cy="335" r="6" class="architecture-status" id="status-audit" />
            </g>

            <!-- Superuser Functions -->
            <g class="architecture-group architecture-group--clickable" id="group-superuser" data-group="superuser">
              <rect x="650" y="320" width="130" height="60" rx="6" class="architecture-node architecture-node--group" />
              <text x="715" y="345" text-anchor="middle" class="architecture-node__label">Kerfisstjórn</text>
              <text x="715" y="362" text-anchor="middle" class="architecture-node__count">7 þjónustur</text>
              <circle cx="760" cy="335" r="6" class="architecture-status" id="status-superuser" />
            </g>
          </g>

          <!-- Layer 5: Databases & External Services -->
          <g class="architecture-layer" id="layer-databases">
            <!-- Kenni.is -->
            <g class="architecture-group" id="group-kenni" data-group="kenni">
              <rect x="50" y="430" width="140" height="60" rx="6" class="architecture-node architecture-node--external" />
              <text x="120" y="455" text-anchor="middle" class="architecture-node__label">Kenni.is</text>
              <text x="120" y="472" text-anchor="middle" class="architecture-node__sublabel">OAuth 2.0</text>
            </g>

            <!-- Cloud SQL -->
            <g class="architecture-group" id="group-cloudsql" data-group="cloudsql">
              <rect x="250" y="430" width="140" height="60" rx="6" class="architecture-node architecture-node--database" />
              <text x="320" y="455" text-anchor="middle" class="architecture-node__label">Cloud SQL</text>
              <text x="320" y="472" text-anchor="middle" class="architecture-node__sublabel">PostgreSQL</text>
              <circle cx="370" cy="445" r="6" class="architecture-status" id="status-cloudsql" />
            </g>

            <!-- Django (Linode) -->
            <g class="architecture-group" id="group-django" data-group="django">
              <rect x="420" y="430" width="140" height="60" rx="6" class="architecture-node architecture-node--external" />
              <text x="490" y="455" text-anchor="middle" class="architecture-node__label">Django</text>
              <text x="490" y="472" text-anchor="middle" class="architecture-node__sublabel">Linode</text>
              <circle cx="540" cy="445" r="6" class="architecture-status" id="status-django" />
            </g>
          </g>

          <!-- Legend - Status indicators -->
          <g class="architecture-legend" transform="translate(600, 510)">
            <text x="0" y="0" class="architecture-legend__title" font-weight="600">Staða:</text>
            <circle cx="10" cy="20" r="5" class="architecture-status architecture-status--healthy" />
            <text x="20" y="24" class="architecture-legend__label">Heilbrigt</text>
            <circle cx="85" cy="20" r="5" class="architecture-status architecture-status--degraded" />
            <text x="95" y="24" class="architecture-legend__label">Hægvirkt</text>
            <circle cx="165" cy="20" r="5" class="architecture-status architecture-status--down" />
            <text x="175" y="24" class="architecture-legend__label">Niðri</text>
          </g>

          <!-- Legend - Data flow -->
          <g class="architecture-legend" transform="translate(50, 510)">
            <text x="0" y="0" class="architecture-legend__title" font-weight="600">Gagnaflæði:</text>
            <!-- Django → Firestore (blue) -->
            <line x1="0" y1="20" x2="25" y2="20" stroke="#3b82f6" stroke-width="2" stroke-dasharray="4,2" />
            <text x="30" y="24" class="architecture-legend__label">Django → Firestore</text>
            <!-- Firestore → Django (green) -->
            <line x1="150" y1="20" x2="175" y2="20" stroke="#22c55e" stroke-width="2" stroke-dasharray="4,2" />
            <text x="180" y="24" class="architecture-legend__label">Firestore → Django</text>
            <!-- Cloud SQL (orange) -->
            <line x1="305" y1="20" x2="330" y2="20" stroke="#f59e0b" stroke-width="2" stroke-dasharray="4,2" />
            <text x="335" y="24" class="architecture-legend__label">SQL fyrirspurnir</text>
            <!-- OAuth (purple) -->
            <line x1="430" y1="20" x2="455" y2="20" stroke="#8b5cf6" stroke-width="2" stroke-dasharray="4,2" />
            <text x="460" y="24" class="architecture-legend__label">OAuth</text>
          </g>
        </svg>
      </div>
    </div>

    <!-- Details Panel (Hidden by default) -->
    <div class="card hidden" id="details-panel">
      <div class="details-header">
        <h3 class="card__title" id="details-title" data-i18n="architecture_service_info">Þjónustuupplýsingar</h3>
        <button type="button" class="btn btn--text" id="close-details" data-i18n="architecture_close_btn">✕ Loka</button>
      </div>
      <div class="service-grid" id="details-services">
        <!-- Service cards will be rendered here -->
      </div>
    </div>

    <!-- Quick Stats Card -->
    <div class="card">
      <h2 class="card__title" data-i18n="architecture_stats_title">Tölfræði</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <span class="stat-card__value" id="stat-total">22</span>
          <span class="stat-card__label" data-i18n="architecture_services_label">Þjónustur</span>
        </div>
        <div class="stat-card stat-card--success">
          <span class="stat-card__value" id="stat-healthy">-</span>
          <span class="stat-card__label" data-i18n="architecture_stat_healthy">Heilbrigðar</span>
        </div>
        <div class="stat-card stat-card--warning">
          <span class="stat-card__value" id="stat-degraded">-</span>
          <span class="stat-card__label" data-i18n="architecture_stat_degraded">Hægvirkar</span>
        </div>
        <div class="stat-card stat-card--error">
          <span class="stat-card__value" id="stat-down">-</span>
          <span class="stat-card__label" data-i18n="architecture_stat_down">Niðri</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Page logic script -->
  <script type="module" src="/superuser/js/architecture.js?v=20251201"></script>

  <!-- Navigation initialization -->
  <script type="module">
    import { initNavHeader, NAV_CONFIGS } from '../ui/components/navigation-bar.js?v=20251201';
    await initNavHeader(NAV_CONFIGS.superuserArchitecture);
  </script>
</body>
</html>
