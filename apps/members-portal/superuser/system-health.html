<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title" data-i18n="health_page_title">Heilbrigði kerfis - Kerfisstjórn</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- Reuse member portal styles -->
  <link rel="stylesheet" href="/styles/bundle.css?v=20251202">

  <!-- Superuser-specific styles -->
  <link rel="stylesheet" href="/superuser/styles/superuser.css?v=20251201c">
</head>
<body class="authenticated superuser">
  <!-- Navigation component inserted here -->

  <!-- Page Content -->
  <div class="page__container">
    <!-- Header Card -->
    <div class="card">
      <div class="health-header">
        <div>
          <h1 class="card__title" data-i18n="health_header_title">Staða kerfis</h1>
          <p class="card__description" data-i18n="health_header_desc">Rauntímastaða allra þjónusta.</p>
        </div>
        <button type="button" class="btn btn--outline" id="refresh-btn" data-i18n="health_refresh_btn">
          Uppfæra
        </button>
      </div>
      <div class="health-summary" id="health-summary">
        <div class="health-summary__status health-summary__status--loading">
          <span class="health-summary__dot"></span>
          <span class="health-summary__text" data-i18n="health_checking">Athuga stöðu...</span>
        </div>
        <span class="health-summary__time" id="last-updated">-</span>
      </div>
    </div>

    <!-- Core GCP Services (with health endpoints) -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_gcp">GCP þjónustur</h2>
      <p class="card__description u-text-muted" data-i18n="health_section_gcp_desc">Google Cloud Run þjónustur með heilsuskoðun.</p>
      <div class="service-grid" id="core-services">
        <!-- Services will be rendered here -->
      </div>
    </div>

    <!-- External Services (Linode, etc.) -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_external">Ytri þjónustur</h2>
      <p class="card__description u-text-muted" data-i18n="health_section_external_desc">Þjónustur hýstar utan GCP (Linode o.fl.)</p>
      <div class="service-grid" id="external-services">
        <!-- Services will be rendered here -->
      </div>
    </div>

    <!-- Demo/Test Services -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_demo">Tilraunaþjónustur</h2>
      <p class="card__description u-text-muted" data-i18n="health_section_demo_desc">Þjónustur í þróun/prófun – ekki í framleiðslu.</p>
      <div class="service-grid" id="demo-services">
        <!-- Services will be rendered here -->
      </div>
    </div>

    <!-- Firebase Functions - Member Operations -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_members">Félagaþjónustur</h2>
      <p class="card__description u-text-muted" data-i18n="health_section_members_desc">Þjónustur fyrir félagaskrá, auðkenningu og samstillingu.</p>
      <div class="service-grid" id="member-functions">
        <!-- Services will be rendered here -->
      </div>
    </div>

    <!-- Firebase Functions - Address Validation -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_address">Heimilisfangaþjónustur</h2>
      <p class="card__description u-text-muted" data-i18n="health_section_address_desc">Þjónustur fyrir heimilisfangaleit og staðfestingu.</p>
      <div class="service-grid" id="address-functions">
        <!-- Services will be rendered here -->
      </div>
    </div>

    <!-- Firebase Functions - Superuser Operations -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_superuser">Kerfisstjóraþjónustur</h2>
      <p class="card__description u-text-muted" data-i18n="health_section_superuser_desc">Þjónustur fyrir kerfisstjórnun og eftirlit.</p>
      <div class="service-grid" id="superuser-functions">
        <!-- Services will be rendered here -->
      </div>
    </div>

    <!-- Firebase Functions - Utility/Background -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_utility">Hjálparföll</h2>
      <p class="card__description u-text-muted" data-i18n="health_section_utility_desc">Bakgrunnsföll og hjálparföll.</p>
      <div class="service-grid" id="utility-functions">
        <!-- Services will be rendered here -->
      </div>
    </div>

    <!-- Database & Storage -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_database">Gagnagrunnar</h2>
      <div class="service-grid" id="database-services">
        <!-- Services will be rendered here -->
      </div>
    </div>

    <!-- Database Schema Overview -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_schema">Gagnagrunna skemu</h2>
      <p class="card__description u-text-muted" data-i18n="health_section_schema_desc">Yfirlit yfir gagnaskipan í Firestore og PostgreSQL.</p>

      <div class="schema-overview">
        <div class="schema-section">
          <h3 class="schema-section__title" data-i18n="schema_firestore_title">Firestore Collections</h3>
          <div class="schema-table">
            <div class="schema-row schema-row--header">
              <span class="schema-col schema-col--name" data-i18n="schema_col_collection">Collection</span>
              <span class="schema-col schema-col--desc" data-i18n="schema_col_desc">Description</span>
              <span class="schema-col schema-col--key" data-i18n="schema_col_key">Primary Key</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>/members/{kennitala}</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_members_desc">Member profiles (synced from Django)</span>
              <span class="schema-col schema-col--key" data-i18n="schema_members_key">kennitala (SSN)</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>/users/{firebaseUid}</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_users_desc">Firebase Auth user data, login history</span>
              <span class="schema-col schema-col--key" data-i18n="schema_users_key">Firebase UID</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>/elections/{id}</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_elections_desc">Election definitions and metadata</span>
              <span class="schema-col schema-col--key" data-i18n="schema_elections_key">Auto-generated ID</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>/events/{id}</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_events_desc">Event definitions (meetings, assemblies)</span>
              <span class="schema-col schema-col--key" data-i18n="schema_events_key">Auto-generated ID</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>/_health/ping</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_health_desc">Health check document</span>
              <span class="schema-col schema-col--key" data-i18n="schema_health_key">Static</span>
            </div>
          </div>
        </div>

        <div class="schema-section">
          <h3 class="schema-section__title" data-i18n="schema_cloudsql_title">Cloud SQL (PostgreSQL) - ekklesia-db</h3>
          <div class="schema-table">
            <div class="schema-row schema-row--header">
              <span class="schema-col schema-col--name" data-i18n="schema_col_table">Table</span>
              <span class="schema-col schema-col--desc" data-i18n="schema_col_desc">Description</span>
              <span class="schema-col schema-col--key" data-i18n="schema_col_key">Primary Key</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>membership_comrade</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_comrade_desc">Django member records (source of truth on Linode)</span>
              <span class="schema-col schema-col--key" data-i18n="schema_comrade_key">id (auto)</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>membership_newlocaladdress</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_newlocaladdress_desc">Member addresses linked to Iceland address registry</span>
              <span class="schema-col schema-col--key" data-i18n="schema_newlocaladdress_key">id (auto)</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>membership_simpleaddress</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_simpleaddress_desc">Simple address storage (829 records)</span>
              <span class="schema-col schema-col--key" data-i18n="schema_simpleaddress_key">comrade_id (FK)</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>membership_contactinfo</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_contactinfo_desc">Phone, email, Facebook for each member</span>
              <span class="schema-col schema-col--key" data-i18n="schema_contactinfo_key">comrade_id (FK)</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>elections_election</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_election_desc">Election records</span>
              <span class="schema-col schema-col--key" data-i18n="schema_election_key">id (auto)</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>elections_ballot</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_ballot_desc">Anonymous ballot submissions</span>
              <span class="schema-col schema-col--key" data-i18n="schema_ballot_key">id (auto)</span>
            </div>
            <div class="schema-row">
              <span class="schema-col schema-col--name"><code>elections_votingtoken</code></span>
              <span class="schema-col schema-col--desc" data-i18n="schema_votingtoken_desc">One-time voting tokens</span>
              <span class="schema-col schema-col--key" data-i18n="schema_votingtoken_key">token (UUID)</span>
            </div>
          </div>
        </div>

        <div class="schema-section">
          <h3 class="schema-section__title" data-i18n="schema_relations_title">Key Relationships</h3>
          <ul class="schema-relations">
            <li><code>/members/{kennitala}.firebaseUid</code> ↔ <code>/users/{firebaseUid}.kennitala</code> (bidirectional link)</li>
            <li><code>membership_comrade.ssn</code> → <code>/members/{kennitala}</code> (Django → Firestore sync)</li>
            <li><code>membership_newlocaladdress.comrade_id</code> → <code>membership_comrade.id</code> (address ownership)</li>
            <li><code>membership_contactinfo.comrade_id</code> → <code>membership_comrade.id</code> (contact info)</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Firebase Infrastructure -->
    <div class="card">
      <h2 class="card__title" data-i18n="health_section_firebase">Firebase innviðir</h2>
      <div class="service-grid" id="firebase-services">
        <!-- Services will be rendered here -->
      </div>
    </div>
  </div>

  <script type="module" src="/superuser/js/system-health.js?v=20251201"></script>

  <!-- Initialize Navigation Component -->
  <script type="module">
    import { initNavHeader, NAV_CONFIGS } from '../ui/components/navigation-bar.js?v=20251201';
    await initNavHeader(NAV_CONFIGS.superuserSystemHealth);
  </script>

</body>
</html>
