<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{t:auth.processingLogin}}</title>

  <!-- Global Styles -->
  <link rel="stylesheet" href="/styles/global.css">
  <!-- Component Styles -->
  <link rel="stylesheet" href="/styles/components/login.css">
</head>
<body>
  <div class="container text-center">
    <div class="login-card">
      <div class="login-logo">üèõÔ∏è</div>
      <h1 class="login-title">{{t:auth.processingLogin}}</h1>
      <p class="login-subtitle" id="status-message">{{t:auth.verifyingWithKenni}}</p>

      <div class="loading-spinner">
        <div class="spinner"></div>
      </div>

      <div id="error-message" class="error-message" style="display: none;">
        <p class="error-text"></p>
        <a href="/login" class="btn btn-primary">{{t:auth.tryAgain}}</a>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Firebase configuration (from environment)
    const firebaseConfig = {
      apiKey: "{{FIREBASE_API_KEY}}",
      authDomain: "{{FIREBASE_AUTH_DOMAIN}}",
      projectId: "{{FIREBASE_PROJECT_ID}}",
      storageBucket: "{{FIREBASE_STORAGE_BUCKET}}",
      messagingSenderId: "{{FIREBASE_MESSAGING_SENDER_ID}}",
      appId: "{{FIREBASE_APP_ID}}"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Kenni.is configuration
    const KENNI_IS_ISSUER_URL = 'https://idp.kenni.is/sosi-kosningakerfi.is';
    const PROJECT_ID = firebaseConfig.projectId;

    // Get Cloud Function URL
    function getCloudFunctionURL() {
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return `http://127.0.0.1:5001/${PROJECT_ID}/europe-west2/handleKenniAuth`;
      } else {
        return `https://europe-west2-${PROJECT_ID}.cloudfunctions.net/handleKenniAuth`;
      }
    }

    // Update status message
    function updateStatus(message) {
      document.getElementById('status-message').textContent = message;
    }

    // Show error
    function showError(message) {
      document.querySelector('.loading-spinner').style.display = 'none';
      document.getElementById('error-message').style.display = 'block';
      document.querySelector('.error-text').textContent = message;
    }

    // Handle OAuth callback
    async function handleCallback() {
      try {
        // Get URL parameters
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const error = params.get('error');
        const error_description = params.get('error_description');

        // Check for OAuth error
        if (error) {
          throw new Error(error_description || error);
        }

        // Get PKCE verifier from sessionStorage
        const pkceCodeVerifier = sessionStorage.getItem('pkce_code_verifier');

        if (!code) {
          throw new Error('{{t:auth.noAuthCode}}');
        }

        if (!pkceCodeVerifier) {
          throw new Error('{{t:auth.noPkceVerifier}}');
        }

        console.log('INFO: Received authorization code from Kenni.is');
        updateStatus('{{t:auth.exchangingCode}}');

        // Call Cloud Function to exchange code for custom token
        const functionUrl = getCloudFunctionURL();
        console.log('INFO: Calling Cloud Function:', functionUrl);

        const response = await fetch(functionUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            kenniAuthCode: code,
            pkceCodeVerifier: pkceCodeVerifier
          }),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`{{t:auth.cloudFunctionError}}: ${response.status} - ${errorText}`);
        }

        const data = await response.json();

        if (!data.customToken) {
          throw new Error('{{t:auth.noCustomToken}}');
        }

        console.log('INFO: Received custom token from Cloud Function');
        updateStatus('{{t:auth.signingIn}}');

        // Sign in to Firebase with custom token
        const userCredential = await signInWithCustomToken(auth, data.customToken);

        console.log('INFO: Successfully signed in with custom token');
        console.log('INFO: User UID:', userCredential.user.uid);

        // Clean up
        sessionStorage.removeItem('pkce_code_verifier');

        updateStatus('{{t:auth.success}}');

        // Redirect to profile page
        setTimeout(() => {
          window.location.href = '/profile';
        }, 500);

      } catch (error) {
        console.error('ERROR: Failed to handle callback:', error);
        showError(error.message || '{{t:auth.unknownError}}');
      }
    }

    // Start handling callback when page loads
    handleCallback();
  </script>

  <style>
    .loading-spinner {
      margin: 2rem 0;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary-color, #3b82f6);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error-message {
      margin-top: 2rem;
    }

    .error-text {
      color: var(--danger-color, #ef4444);
      margin-bottom: 1rem;
    }
  </style>
</body>
</html>
