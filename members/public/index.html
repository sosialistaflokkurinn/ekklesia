<!DOCTYPE html>
<html lang="is">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Innskráning - Sósíalistaflokkurinn</title>
  <link rel="stylesheet" href="/styles/global.css">
  <link rel="stylesheet" href="/styles/components/login.css">
</head>
<body>
  <div class="container">
    <h1>Innskráning</h1>
    <p class="subtitle">Félagar Sósíalistaflokksins</p>

    <div id="status" class="status not-authenticated">
      Ekki innskráð(ur)
    </div>

    <div class="info-box" id="user-info" style="display: none;">
      <p><strong>Display Name:</strong> <span id="display-name">-</span></p>
      <p><strong>UID:</strong> <span id="uid">-</span></p>
      <p><strong>Kennitala:</strong> <span id="kennitala">-</span></p>
      <p><strong>Email:</strong> <span id="email">-</span></p>
      <p><strong>Phone:</strong> <span id="phone">-</span></p>
    </div>

    <div id="auth-buttons">
      <button class="btn" onclick="signInWithKenni()">
        Skrá inn með Kenni.is
      </button>
      <p style="color: #718096; font-size: 14px; margin-top: 8px;">
        Auðkenning með rafrænum skilríkjum
      </p>
    </div>

    <button id="signout-btn" class="btn secondary" onclick="signOut()" style="display: none;">
      Útskrá
    </button>

    <div class="debug-log">
      <strong>Debug Log:</strong>
      <div id="log"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { R } from '/i18n/R.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signInWithCustomToken,
      signOut as firebaseSignOut
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Set page title from R.string
    document.title = R.string.page_title;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBsDqnt8G54VAANlucQpI20r3Sw1p2Bcp4",
      authDomain: "ekklesia-prod-10-2025.firebaseapp.com",
      projectId: "ekklesia-prod-10-2025",
      storageBucket: "ekklesia-prod-10-2025.firebasestorage.app",
      messagingSenderId: "521240388393",
      appId: "1:521240388393:web:de2a986ae545e20bb5cd38"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // Kenni.is configuration
    const KENNI_IS_ISSUER_URL = 'https://idp.kenni.is/sosi-kosningakerfi.is';
    const KENNI_IS_CLIENT_ID = '@sosi-kosningakerfi.is/rafr-nt-kosningakerfi-s-s';
    const KENNI_IS_REDIRECT_URI = window.location.origin + window.location.pathname;

    // Logging
    function addLog(message, type = 'info') {
      const log = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> <span class="${type}">${message}</span>`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // Base64 URL encode
    function base64URLEncode(buffer) {
      const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    // SHA-256 hash
    async function sha256(buffer) {
      return await crypto.subtle.digest('SHA-256', buffer);
    }

    // Generate PKCE challenge
    async function generatePKCE() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      const verifier = base64URLEncode(array);

      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const hash = await sha256(data);
      const challenge = base64URLEncode(hash);

      return { verifier, challenge };
    }

    // Sign in with Kenni.is
    window.signInWithKenni = async function() {
      try {
        addLog('Initiating Kenni.is OAuth flow...', 'info');

        const { verifier, challenge } = await generatePKCE();
        sessionStorage.setItem('pkce_code_verifier', verifier);
        addLog('PKCE challenge generated', 'success');

        const params = new URLSearchParams({
          client_id: KENNI_IS_CLIENT_ID,
          redirect_uri: KENNI_IS_REDIRECT_URI,
          response_type: 'code',
          scope: 'openid profile national_id email phone_number',
          code_challenge: challenge,
          code_challenge_method: 'S256',
        });

        const authUrl = `${KENNI_IS_ISSUER_URL}/oidc/auth?${params.toString()}`;
        addLog('Redirecting to Kenni.is...', 'info');

        window.location.assign(authUrl);
      } catch (error) {
        addLog(`Error: ${error.message}`, 'error');
      }
    };

    // Handle OAuth callback
    async function handleCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const error = params.get('error');

      if (error) {
        addLog(`${R.string.error_callback}: ${error}`, 'error');
        return;
      }

      if (!code) return; // Not a callback

      addLog(R.string.log_oauth_callback, 'info');

      const verifier = sessionStorage.getItem('pkce_code_verifier');
      if (!verifier) {
        addLog('No PKCE verifier found', 'error');
        return;
      }

      try {
        addLog(R.string.log_calling_function, 'info');

        const functionUrl = 'https://handlekenniauth-ymzrguoifa-nw.a.run.app';
        const response = await fetch(functionUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            kenniAuthCode: code,
            pkceCodeVerifier: verifier
          }),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`${R.string.error_function}: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        addLog(R.string.log_received_token, 'success');

        addLog(R.string.log_signing_in, 'info');
        await signInWithCustomToken(auth, data.customToken);

        addLog(R.string.log_signed_in, 'success');
        sessionStorage.removeItem('pkce_code_verifier');

        // Clear URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);

      } catch (error) {
        addLog(`${R.string.error_callback}: ${error.message}`, 'error');
      }
    }

    // Sign out
    window.signOut = async function() {
      try {
        await firebaseSignOut(auth);
        addLog(R.string.log_signed_out, 'success');
      } catch (error) {
        addLog(`${R.string.error_signout}: ${error.message}`, 'error');
      }
    };

    // Auth state observer
    onAuthStateChanged(auth, async (user) => {
      const statusDiv = document.getElementById('status');
      const authButtons = document.getElementById('auth-buttons');
      const signoutBtn = document.getElementById('signout-btn');
      const userInfo = document.getElementById('user-info');

      if (user) {
        statusDiv.className = 'status authenticated';
        statusDiv.textContent = R.string.status_authenticated;
        authButtons.style.display = 'none';
        signoutBtn.style.display = 'block';
        userInfo.style.display = 'block';

        document.getElementById('display-name').textContent = user.displayName || 'N/A';
        document.getElementById('uid').textContent = user.uid;

        const idTokenResult = await user.getIdTokenResult();
        const kennitala = idTokenResult.claims.kennitala || R.string.placeholder_not_found;
        const email = idTokenResult.claims.email || R.string.placeholder_not_available;
        const phone = idTokenResult.claims.phoneNumber || R.string.placeholder_not_available;

        document.getElementById('kennitala').textContent = kennitala;
        document.getElementById('email').textContent = email;
        document.getElementById('phone').textContent = phone;

        addLog(`${R.string.log_user_authenticated}: ${user.displayName || user.uid}`, 'success');
        addLog(`${R.string.label_kennitala}: ${kennitala}`, 'info');
        addLog(`${R.string.label_email}: ${email}`, 'info');
        addLog(`${R.string.label_phone}: ${phone}`, 'info');
      } else {
        statusDiv.className = 'status not-authenticated';
        statusDiv.textContent = R.string.status_not_authenticated;
        authButtons.style.display = 'block';
        signoutBtn.style.display = 'none';
        userInfo.style.display = 'none';
      }
    });

    // Initialize
    addLog(R.string.log_page_loaded, 'info');
    handleCallback();
  </script>
</body>
</html>
