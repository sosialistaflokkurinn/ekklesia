name: Documentation Freshness Check

on:
  # Run on every push to main
  push:
    branches: [main]

  # Run weekly on Mondays at 9:00 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  check-docs:
    name: Check if key docs are up-to-date
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log

      - name: Check documentation freshness
        id: check
        run: |
          chmod +x scripts/admin/documentation-maintenance/check-docs-freshness.sh
          scripts/admin/documentation-maintenance/check-docs-freshness.sh 14  # 14 days threshold
        continue-on-error: true

      - name: Create issue if docs are stale
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const issueTitle = 'üìù Documentation Update Needed';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,automated'
            });

            const existingIssue = issues.data.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              console.log('Issue already exists:', existingIssue.html_url);
              return;
            }

            // Create new issue
            const body = `## üìù Key Documentation Files Need Updates

            The following key documentation files have not been updated recently (threshold: 14 days):

            ### Files to Review:
            - [ ] \`docs/status/CURRENT_DEVELOPMENT_STATUS.md\`
            - [ ] \`docs/development/guides/workflows/USAGE_CONTEXT.md\`
            - [ ] \`docs/operations/OPERATIONAL_PROCEDURES.md\`

            ### Why This Matters:
            These files are loaded at every Claude Code session start and must reflect the current state of the system.

            ### Action Required:
            1. Review each file and update with recent changes
            2. Check git commits since last update: \`git log --since="14 days ago" --oneline\`
            3. Update docs to reflect any:
               - New deployments or infrastructure changes
               - New operational procedures
               - New security rules or gitignore patterns
               - New usage patterns or workflows

            ### Related:
            - See: \`docs/development/guides/DOCUMENTATION_MAINTENANCE.md\`
            - Run locally: \`./scripts/admin/documentation-maintenance/check-docs-freshness.sh 14\`

            **Auto-generated by:** [Documentation Freshness Check workflow](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: body,
              labels: ['documentation', 'automated', 'maintenance']
            });

            console.log('Created new issue for stale documentation');

      - name: Comment on PR if docs are stale (for PR events)
        if: steps.check.outcome == 'failure' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const body = `## ‚ö†Ô∏è Documentation Update Reminder

            Some key documentation files haven't been updated in 14+ days.

            If this PR includes significant changes, please also update:
            - \`docs/status/CURRENT_DEVELOPMENT_STATUS.md\` (if infrastructure changed)
            - \`docs/operations/OPERATIONAL_PROCEDURES.md\` (if procedures changed)

            Run \`./scripts/admin/documentation-maintenance/check-docs-freshness.sh\` to check.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
