name: Weekly TODO Health Report

on:
  schedule:
    # Every Monday at 9:00 AM UTC (10:00 AM Iceland time in winter)
    - cron: '0 9 * * 1'

  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write # Needed to create issues/comments
  issues: write

jobs:
  generate-todo-report:
    name: Generate TODO Health Report
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for git analysis

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # No external dependencies needed for check-todo-health.py

      - name: Run TODO health check
        id: todo_check
        run: |
          # Check if metadata inventory exists (generated locally, not in repo)
          if [ ! -f ".metadata_store/md_inventory.json" ]; then
            echo "âš ï¸ Skipping TODO health check - metadata inventory not found" > todo-report.txt
            echo "The .metadata_store/ directory is gitignored and must be generated locally." >> todo-report.txt
            echo "Run: python3 scripts/maintenance/generate_metadata.py" >> todo-report.txt
            echo "report_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          python3 scripts/maintenance/check-todo-health.py > todo-report.txt 2>&1
          echo "report_generated=true" >> $GITHUB_OUTPUT
        continue-on-error: true # Don't fail if TODO health is bad

      - name: Read TODO report
        id: read_report
        run: |
          if [ -f todo-report.txt ]; then
            # Escape special characters for GitHub Actions
            REPORT=$(cat todo-report.txt)
            echo "TODO_REPORT<<EOF" >> $GITHUB_ENV
            echo "$REPORT" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "TODO_REPORT=Report generation failed" >> $GITHUB_ENV
          fi

      - name: Extract key metrics
        id: metrics
        run: |
          # Extract key metrics from report
          TOTAL_TODOS=$(grep -oP 'Total TODOs:\s+\K\d+' todo-report.txt || echo "0")
          COMPLETION_RATE=$(grep -oP 'Completion Rate:\s+\K[\d.]+' todo-report.txt || echo "0")
          SCORE=$(grep -oP 'Overall Score:\s+\K\d+' todo-report.txt || echo "0")
          GRADE=$(grep -oP 'Grade:\s+\K[A-F]' todo-report.txt || echo "F")

          echo "total_todos=$TOTAL_TODOS" >> $GITHUB_OUTPUT
          echo "completion_rate=$COMPLETION_RATE" >> $GITHUB_OUTPUT
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "grade=$GRADE" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        uses: actions/github-script@v8
        with:
          script: |
            const score = '${{ steps.metrics.outputs.score }}';
            const grade = '${{ steps.metrics.outputs.grade }}';
            const totalTodos = '${{ steps.metrics.outputs.total_todos }}';
            const completionRate = '${{ steps.metrics.outputs.completion_rate }}';

            // Determine issue labels based on score
            let labels = ['documentation', 'maintenance'];
            if (score < 50) {
              labels.push('priority: critical');
            } else if (score < 70) {
              labels.push('priority: high');
            }

            // Determine emoji based on grade
            let gradeEmoji = 'âŒ';
            if (grade === 'A') gradeEmoji = 'ðŸŸ¢';
            else if (grade === 'B') gradeEmoji = 'ðŸ”µ';
            else if (grade === 'C') gradeEmoji = 'ðŸŸ¡';
            else if (grade === 'D') gradeEmoji = 'ðŸŸ ';
            else if (grade === 'F') gradeEmoji = 'ðŸ”´';

            const issueTitle = `ðŸ“Š Weekly TODO Health Report - Grade: ${grade} ${gradeEmoji} (Score: ${score}/100)`;

            const report = process.env.TODO_REPORT;

            const issueBody = [
              '## Weekly TODO Health Report',
              '',
              `**Date:** ${new Date().toISOString().split('T')[0]}`,
              `**Overall Score:** ${score}/100`,
              `**Grade:** ${grade} ${gradeEmoji}`,
              `**Total TODOs:** ${totalTodos}`,
              `**Completion Rate:** ${completionRate}%`,
              '',
              '---',
              '',
              '## Full Report',
              '',
              '```',
              report,
              '```',
              '',
              '---',
              '',
              '## Next Steps',
              '',
              '1. Review files with 0% completion rate',
              '2. Close or archive completed TODOs',
              '3. Break down large checklists (>30 items)',
              '4. Convert critical TODOs to GitHub Issues',
              '',
              'See [TODO_CLEANUP_STRATEGY.md](../docs/standards/TODO_CLEANUP_STRATEGY.md) for guidance.',
              '',
              '---',
              '',
              '**Automated Report** - Generated by `check-todo-health.py`',
              '**Schedule:** Every Monday 9:00 AM UTC',
              '**Workflow:** `.github/workflows/weekly-todo-report.yml`'
            ].join('\n');

            // Check if there's an existing open TODO report issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'weekly-todo-report',
              state: 'open'
            });

            if (issues.data.length > 0) {
              // Close old report
              const oldIssue = issues.data[0];
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: oldIssue.number,
                state: 'closed',
                labels: [...oldIssue.labels.map(l => l.name), 'archived']
              });

              console.log(`Closed old TODO report #${oldIssue.number}`);
            }

            // Create new issue
            labels.push('weekly-todo-report');
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: labels
            });

            console.log(`Created TODO health report issue #${issue.data.number}`);

      - name: Upload report artifact
        uses: actions/upload-artifact@v5
        with:
          name: todo-health-report-${{ github.run_number }}
          path: todo-report.txt
          retention-days: 90

      - name: Comment on pull requests (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const report = process.env.TODO_REPORT;
            const score = '${{ steps.metrics.outputs.score }}';
            const grade = '${{ steps.metrics.outputs.grade }}';

            const comment = [
              '## ðŸ“Š TODO Health Check',
              '',
              `**Score:** ${score}/100 (Grade: ${grade})`,
              '',
              '<details>',
              '<summary>View full report</summary>',
              '',
              '```',
              report,
              '```',
              '',
              '</details>',
              '',
              '_This is an automated check from the weekly TODO health workflow._'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
