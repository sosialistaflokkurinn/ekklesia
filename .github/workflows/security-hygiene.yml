name: Weekly Security Hygiene

# Run every Monday at 9 AM Iceland time (UTC +0 in winter, +1 in summer)
# Using UTC 9 AM = 9 AM GMT (close enough for Iceland)
on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  issues: write
  contents: read

# Don't cancel security checks - let them complete
concurrency:
  group: security-hygiene
  cancel-in-progress: false

jobs:
  security-audit:
    runs-on: ubuntu-latest
    name: Automated Security Checks
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Verify GitHub CLI is available
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            echo "‚ùå GitHub CLI not found"
            exit 1
          fi
          echo "‚úÖ GitHub CLI version: $(gh --version | head -n1)"

      - name: Run security hygiene checks (with retry)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Retry logic for transient failures
          MAX_ATTEMPTS=3
          RETRY_DELAY=10

          for attempt in $(seq 1 $MAX_ATTEMPTS); do
            echo "üîÑ Attempt $attempt of $MAX_ATTEMPTS..."

            if bash .github/scripts/security-hygiene.sh; then
              echo "‚úÖ Security hygiene checks completed successfully"
              exit 0
            fi

            EXIT_CODE=$?
            echo "‚ùå Attempt $attempt failed with exit code $EXIT_CODE"

            if [ $attempt -lt $MAX_ATTEMPTS ]; then
              echo "‚è≥ Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          echo "‚ùå All $MAX_ATTEMPTS attempts failed"
          exit 1
