name: PII Check

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  issues: write
  pull-requests: write

jobs:
  check-pii:
    runs-on: ubuntu-latest
    name: Scan for PII in Issues/PRs/Comments

    steps:
      - name: Check for PII patterns
        uses: actions/github-script@v8
        with:
          script: |
            // Domains to exclude from email PII detection (not personal emails)
            const excludedEmailDomains = [
              'example.com',
              'example.org',
              'example.net',
              // GCP service accounts
              'developer.gserviceaccount.com',
              'cloudservices.gserviceaccount.com',
              'appspot.gserviceaccount.com',
              'iam.gserviceaccount.com',
              // Other service accounts
              'noreply.github.com',
              'github.com',
            ];

            // PII patterns (excluding clearly fake examples)
            const patterns = {
              kennitala: {
                regex: /\b(0[1-9]|[12][0-9]|3[01])(0[1-9]|1[0-2])[0-9]{2}-?(?!0000|1111|2939)[0-9]{4}\b/g,
                name: 'Kennitala (Icelandic SSN)'
              },
              email: {
                regex: /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/gi,
                name: 'Email address',
                filter: (match) => {
                  const domain = match.split('@')[1]?.toLowerCase();
                  return !excludedEmailDomains.some(excluded => domain?.endsWith(excluded));
                }
              },
              phone: {
                regex: /\b(?!555-1234|000-0000)[0-9]{3}[\s-]?[0-9]{4}\b/g,
                name: 'Phone number (Icelandic format)'
              }
            };

            // Get content to check
            let body = '';
            let title = '';

            if (context.payload.issue) {
              body = context.payload.issue.body || '';
              title = context.payload.issue.title || '';
            } else if (context.payload.pull_request) {
              body = context.payload.pull_request.body || '';
              title = context.payload.pull_request.title || '';
            } else if (context.payload.comment) {
              body = context.payload.comment.body || '';
            }

            const fullText = title + '\n\n' + body;

            // Check for PII patterns
            const findings = [];
            for (const [type, pattern] of Object.entries(patterns)) {
              let matches = fullText.match(pattern.regex);
              
              // Apply filter if defined (e.g., to exclude service account emails)
              if (matches && pattern.filter) {
                matches = matches.filter(pattern.filter);
              }
              
              if (matches && matches.length > 0) {
                findings.push({
                  type: pattern.name,
                  count: matches.length,
                  examples: matches.slice(0, 3) // Show up to 3 examples
                });
              }
            }

            if (findings.length > 0) {
              const findingsText = findings.map(f =>
                `- **${f.type}**: ${f.count} potential match(es) found`
              ).join('\n');

              const message = `## ‚ö†Ô∏è Potential PII Detected

            This ${context.payload.issue ? 'issue' : context.payload.pull_request ? 'pull request' : 'comment'} may contain personal information:

            ${findingsText}

            ### ‚úÖ Use These Fake Examples Instead:

            - **Names**: "J√≥n J√≥nsson", "Anna J√≥nsd√≥ttir"
            - **Kennitalas**: "010190-0000", "111111-1111"
            - **Emails**: "email@example.com", "user@example.com"
            - **Phones**: "555-1234", "000-0000"
            - **Addresses**: "D√¶misgata 1, 000 D√¶misb√¶r"

            ### Why This Matters:

            This is a **public repository** - all content is visible to everyone on the internet. Including real PII:
            - Violates GDPR and privacy laws
            - Exposes sensitive member data
            - Creates security risks
            - Damages member trust

            ### Action Required:

            1. **Edit this ${context.payload.issue ? 'issue' : context.payload.pull_request ? 'pull request' : 'comment'}** to replace real data with fake examples
            2. If screenshots contain PII, re-upload with data blurred
            3. Never include real member data in public repositories

            ---

            **Related**: Issue #240 (PII Prevention System), Issue #136 (PII Exposure Incident)

            ü§ñ *Auto-generated by PII Check workflow*
            `;

              // Post comment
              if (context.payload.issue) {
                await github.rest.issues.createComment({
                  ...context.repo,
                  issue_number: context.payload.issue.number,
                  body: message
                });
                console.log(`Posted PII warning to issue #${context.payload.issue.number}`);
              } else if (context.payload.pull_request) {
                await github.rest.issues.createComment({
                  ...context.repo,
                  issue_number: context.payload.pull_request.number,
                  body: message
                });
                console.log(`Posted PII warning to PR #${context.payload.pull_request.number}`);
              }

              // Don't fail the workflow - just warn
              core.warning(`Potential PII detected: ${findings.length} pattern(s) matched`);
            } else {
              console.log('‚úÖ No PII patterns detected');
            }
