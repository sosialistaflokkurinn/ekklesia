name: Code Quality Checks

on:
  pull_request:
    paths:
      - 'apps/members-portal/**/*.js'
      - 'apps/members-portal/**/*.html'
      - 'services/**/*.js'
      - 'services/**/*.py'
  push:
    branches:
      - main
    paths:
      - 'apps/members-portal/**/*.js'
      - 'apps/members-portal/**/*.html'
      - 'services/**/*.js'
      - 'services/**/*.py'

jobs:
  code-health:
    name: Code Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Code Health Checker
        id: health-check
        run: |
          python3 scripts/maintenance/check-code-health.py 2>&1 | tee health-output.txt
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Post Summary
        if: always()
        run: |
          echo "### ðŸ” Code Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat health-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checks performed:**" >> $GITHUB_STEP_SUMMARY
          echo "- Missing imports (initNavigation, debug, showToast, R.string)" >> $GITHUB_STEP_SUMMARY
          echo "- console.log usage (should use debug)" >> $GITHUB_STEP_SUMMARY
          echo "- Hardcoded URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Error handling in async functions" >> $GITHUB_STEP_SUMMARY
          echo "- Event listener memory leaks" >> $GITHUB_STEP_SUMMARY
          echo "- TODO/FIXME comments" >> $GITHUB_STEP_SUMMARY

      - name: Check for Errors
        run: |
          # Fail if there were errors (exit code 1)
          if grep -q "âŒ ERRORS" health-output.txt; then
            echo "::error::Code health check found errors. Please fix them before merging."
            exit 1
          fi
          echo "âœ… No critical errors found"

  code-patterns:
    name: Check Code Patterns
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check Code Patterns
        run: |
          chmod +x scripts/maintenance/check-code-patterns.sh
          ./scripts/maintenance/check-code-patterns.sh apps/members-portal/js/
        continue-on-error: true

      - name: Summary
        if: always()
        run: |
          echo "### Code Pattern Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checked patterns based on GitHub Copilot findings:" >> $GITHUB_STEP_SUMMARY
          echo "- API consistency (createBadge, button methods)" >> $GITHUB_STEP_SUMMARY
          echo "- Development markers (TODO, FIXME)" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation examples" >> $GITHUB_STEP_SUMMARY
          echo "- Async error handling" >> $GITHUB_STEP_SUMMARY
          echo "- XSS risks (innerHTML usage)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See [Code Pattern Checks](../../docs/development/guides/CODE_PATTERN_CHECKS.md) for details." >> $GITHUB_STEP_SUMMARY
